{"version":3,"file":"index.js","sources":["../src/index.ts"],"sourcesContent":["import { VNode, options } from \"preact\";\nimport { NativeTouchEvent } from \"react-native\";\n\nlet root: VNode;\n\nconst oldRootHook = (options as any)._root;\n\n(options as any)._root = function (node: VNode) {\n  root = node;\n\n  if (root != null) {\n    addEventListenerToDocument();\n  } else {\n    removeEventListenerToDocument();\n  }\n\n  if (oldRootHook) oldRootHook.apply(null, arguments);\n};\n\nlet oldCommitHook = (options as any)._commit;\n\n(options as any)._commit = function (node: VNode) {\n  if (root && getPlugin()) {\n    const vnodes = [root];\n\n    while (vnodes.length) {\n      const vnode = vnodes.pop();\n\n      // it's a real vnode reflect to the dom\n      if (typeof (vnode as any).type === \"string\") {\n        const dom = (vnode as any)._dom;\n\n        if (dom != null) {\n          dom._vnode = vnode;\n        }\n      }\n\n      if ((vnode as any)._children != null && (vnode as any)._children.length != null) {\n        for (let child of (vnode as any)._children) {\n          if (child != null) {\n            vnodes.push(child);\n          }\n        }\n      }\n    }\n  }\n\n  if (oldCommitHook) oldCommitHook.apply(null, arguments);\n};\n\nenum ProcessType {\n  start = 0,\n  move,\n  end,\n}\nconst startResponderKey = \"onResponderStart\";\nconst moveResponderKey = \"onResponderMove\";\nconst endResponderKey = \"onResponderEnd\";\nconst startCheckerKeys = [\"onStartShouldSetResponderCapture\", \"onStartShouldSetResponder\"];\nconst moveCheckerKeys = [\"onMoveShouldSetResponderCapture\", \"onMoveShouldSetResponder\"];\nconst startDefinition = getEventDefinition(startCheckerKeys, startResponderKey, ProcessType.start);\nconst moveDefinition = getEventDefinition(moveCheckerKeys, moveResponderKey, ProcessType.move);\nconst endDefinition = getEventDefinition([], endResponderKey, ProcessType.end);\n\ninterface IDefinition {\n  prepCheckerKeys: string[];\n  prepResponderKey: string;\n  prepProcess: ProcessType;\n}\n\ninterface IResponderEvents {\n  [key: string]: IDefinition;\n}\n\nconst responderEvents: IResponderEvents = {\n  touchstart: startDefinition,\n  mousedown: startDefinition,\n  touchmove: moveDefinition,\n  mousemove: moveDefinition,\n  touchend: endDefinition,\n  mouseup: endDefinition,\n};\n\nfunction getEventDefinition(prepCheckerKeys: string[], prepResponderKey: string, prepProcess: ProcessType) {\n  return { prepCheckerKeys, prepResponderKey, prepProcess };\n}\n\nfunction addEventListenerToDocument() {\n  for (let event in responderEvents) {\n    document.addEventListener(event, eventListener);\n  }\n}\n\nfunction removeEventListenerToDocument() {\n  for (let event in responderEvents) {\n    document.removeEventListener(event, eventListener);\n  }\n}\n\nfunction getEventPath(e: IEvent) {\n  const path = [e.target];\n  const parent: any[] = [e.target];\n\n  while (parent.length) {\n    const ele = parent.pop();\n    const parentElement = ele.parentElement;\n\n    if (parentElement) {\n      parent.push(parentElement);\n      path.push(parentElement);\n    }\n  }\n\n  return path;\n}\n\ntype IChecker = (e: IEvent) => boolean;\n\ninterface ICheckers {\n  onMoveShouldSetResponderCapture?: IChecker;\n  onMoveShouldSetResponder?: IChecker;\n  onStartShouldSetResponderCapture?: IChecker;\n  onStartShouldSetResponder?: IChecker;\n}\n\ninterface IResponders {\n  onResponderStart?: (e: IEvent) => void;\n  onResponderMove?: (e: IEvent) => void;\n  onResponderEnd?: (e: IEvent) => void;\n}\n\ninterface IProcessors {\n  onResponderTerminationRequest?: IChecker;\n  onResponderTerminate?: (e: IEvent) => void;\n  onResponderGrant?: (e: IEvent) => void;\n  onResponderReject?: (e: IEvent) => void;\n  onResponderRelease?: (e: IEvent) => void;\n}\n\ntype IProps = ICheckers & IResponders & IProcessors;\n\ninterface ICheckerWrapper {\n  prepChecker: IChecker;\n  prepProps: IProps;\n  prepDom: HTMLElement;\n}\n\ninterface IEvent extends UIEvent {\n  nativeEvent: NativeTouchEvent;\n}\n\nfunction getCheckersWithPropsByEventPath(checkerKey: string, eventPath: HTMLElement[], isCapture: boolean) {\n  const checkers: ICheckerWrapper[] = [];\n\n  for (let dom of eventPath) {\n    const vnode = (dom as any)._vnode;\n\n    if (vnode != null) {\n      if (typeof vnode.props === \"object\") {\n        const checker = vnode.props[checkerKey];\n\n        if (checker != null) {\n          checkers.push({\n            prepChecker: checker,\n            prepProps: vnode.props as IProps,\n            prepDom: dom,\n          });\n        }\n      }\n    }\n  }\n\n  return checkers;\n}\n\nfunction getCheckers(eventType: string, eventPath: HTMLElement[], eventPathReverse: HTMLElement[]) {\n  const definition = responderEvents[eventType];\n  const checkerKeys = definition.prepCheckerKeys;\n  const checkers: ICheckerWrapper[] = [];\n\n  for (let key of checkerKeys) {\n    // invoke capture checkers from root\n    if (key.indexOf(\"Capture\") > -1) {\n      checkers.push(...getCheckersWithPropsByEventPath(key, eventPathReverse, true));\n    } else {\n      checkers.push(...getCheckersWithPropsByEventPath(key, eventPath, false));\n    }\n  }\n\n  return checkers;\n}\n\nfunction getEventPaths(e: IEvent) {\n  const composedPath = e.composedPath;\n  const path = (e as any).path || (composedPath != null ? composedPath() : getEventPath(e));\n  const pathReverse = path.concat([]).reverse();\n  return { p: path, pr: pathReverse };\n}\n\nfunction setEvent(e: IEvent, responderKey: keyof IProps, props: IProps) {\n  const responder = props[responderKey];\n  const plugin = getPlugin();\n\n  if (plugin!.prepView) {\n    plugin!.prepView!.prepEvent = {\n      prepResponder: responder,\n      prepType: e.type,\n    };\n  }\n}\n\nfunction initView(e: IEvent, responderKey: keyof IProps, props: IProps, dom: HTMLElement) {\n  const responder = props[responderKey];\n  const plugin = getPlugin();\n\n  plugin!.prepView = {\n    prepEvent: {\n      prepResponder: responder,\n      prepType: e.type,\n    },\n    prepProps: props,\n    prepDom: dom,\n  };\n\n  const { onResponderGrant } = props;\n\n  if (onResponderGrant) onResponderGrant(e);\n}\n\nfunction handleResponderTransferRequest(e: IEvent, definition: IDefinition, props: IProps, dom: HTMLElement) {\n  const view = getCurrentView();\n  // view can't be null here\n  const { onResponderTerminate, onResponderTerminationRequest } = view!.prepProps;\n  const { onResponderReject } = props;\n\n  if (onResponderTerminationRequest) {\n    const allowTransfer = onResponderTerminationRequest(e);\n\n    if (allowTransfer) {\n      initView(e, definition.prepResponderKey as keyof IProps, props, dom);\n      if (onResponderTerminate) onResponderTerminate(e);\n    } else {\n      if (onResponderReject) onResponderReject(e);\n    }\n  } else {\n    initView(e, definition.prepResponderKey as keyof IProps, props, dom);\n    if (onResponderTerminate) onResponderTerminate(e);\n  }\n}\n\nfunction handleActiveTouches(e: IEvent) {\n  ResponderTouchHistoryStore.touchHistory.numberActiveTouches = e.nativeEvent.touches.length;\n}\n\nfunction isStartish(definition: IDefinition) {\n  return definition.prepProcess === ProcessType.start;\n}\n\nfunction isMoveish(definition: IDefinition) {\n  return definition.prepProcess === ProcessType.move;\n}\n\nfunction isEndish(definition: IDefinition) {\n  return definition.prepProcess === ProcessType.end;\n}\n\nfunction getPlugin() {\n  return plugins.ResponderEventPlugin;\n}\n\nfunction getCurrentView() {\n  const plugin = getPlugin();\n  if (plugin) {\n    return plugin.prepView;\n  }\n}\n\nfunction getCurrentEvent() {\n  const view = getCurrentView();\n  if (view) {\n    return view.prepEvent;\n  }\n}\n\nfunction getCurrentResponder() {\n  const event = getCurrentEvent();\n  if (event) {\n    return event.prepResponder;\n  }\n}\n\nfunction executeResponder(e: IEvent, checker: ICheckerWrapper[]) {\n  const definition: IDefinition = responderEvents[e.type];\n\n  handleActiveTouches(e);\n\n  if (isStartish(definition) || isMoveish(definition)) {\n    for (let item of checker) {\n      const requireToBeResponder = item.prepChecker(e);\n\n      if (requireToBeResponder) {\n        const view = getCurrentView();\n\n        // if no responding view, set it and call granted\n        if (view == null) {\n          initView(e, definition.prepResponderKey as keyof IProps, item.prepProps, item.prepDom);\n        } else {\n          // if same view is responding, set new responder\n          if (view.prepDom === item.prepDom) {\n            setEvent(e, definition.prepResponderKey as keyof IProps, item.prepProps);\n          } else {\n            // if other view wants to response, start to negotiate\n            handleResponderTransferRequest(e, definition, item.prepProps, item.prepDom);\n          }\n        }\n\n        break;\n      }\n    }\n\n    const responder = getCurrentResponder();\n\n    if (responder) {\n      responder(e);\n      getPlugin()!.prepView!.prepEvent = null;\n    }\n  }\n\n  if (isEndish(definition)) {\n    const view = getCurrentView();\n\n    if (view != null) {\n      const { onResponderRelease, onResponderEnd } = view.prepProps;\n\n      if (onResponderEnd) {\n        onResponderEnd(e);\n      }\n\n      if (ResponderTouchHistoryStore.touchHistory.numberActiveTouches === 0) {\n        if (onResponderRelease) {\n          onResponderRelease(e);\n        }\n\n        const plugin = getPlugin();\n\n        if (plugin) {\n          plugin.prepView = null;\n        }\n      }\n    }\n  }\n}\n\nfunction eventListener(e: Event) {\n  const plugin = getPlugin();\n\n  if (!plugin) return;\n\n  const result = plugin.extractEvents(e.type, {}, e, e.target as HTMLElement);\n\n  if (result == null) {\n    return;\n  }\n\n  (e as IEvent).nativeEvent = result.nativeEvent;\n\n  const { p, pr } = getEventPaths(e as IEvent);\n  const checkers = getCheckers(e.type, p as HTMLElement[], pr as HTMLElement[]);\n\n  executeResponder(e as IEvent, checkers);\n}\n\ninterface IResponderEventPlugin {\n  prepView: {\n    prepDom: HTMLElement;\n    prepEvent: {\n      prepResponder: ((e: IEvent) => void) | undefined;\n      prepType: string;\n    } | null;\n    prepProps: IProps;\n  } | null;\n  extractEvents: (\n    eventType: string,\n    targetInst: IProps,\n    nativeEvent: Event,\n    nativeEventTarget: HTMLElement\n  ) => { nativeEvent: NativeTouchEvent };\n  eventTypes: any;\n}\n\nexport const ResponderEventPlugin: IResponderEventPlugin = {\n  prepView: null,\n  extractEvents: (eventType: string, props: IProps, nativeEvent: Event, nativeEventTarget: HTMLElement) => {\n    return {\n      // event will transform to NativeTouchEvent by react-native-web\n      nativeEvent: (nativeEvent as any) as NativeTouchEvent,\n    };\n  },\n  eventTypes: {\n    responderMove: {\n      dependencies: [\"touchmove\", \"mousemove\"],\n    },\n  },\n};\n\nexport const ResponderTouchHistoryStore = {\n  touchHistory: { numberActiveTouches: 0 },\n};\n\ninterface IPlugins {\n  ResponderEventPlugin?: IResponderEventPlugin;\n}\n\nlet plugins: IPlugins = {};\n\nexport const injectEventPluginsByName = (injectedPlugins: IPlugins) => {\n  plugins = Object.assign({}, plugins, injectedPlugins);\n};\n\nexport default {\n  injectEventPluginsByName,\n  ResponderEventPlugin,\n  ResponderTouchHistoryStore,\n};\n"],"names":["root","oldRootHook","oldCommitHook","ProcessType","moveCheckerKeys","startDefinition","moveDefinition","endDefinition","responderEvents","ResponderEventPlugin","ResponderTouchHistoryStore","plugins","injectEventPluginsByName","getEventDefinition","prepCheckerKeys","prepResponderKey","prepProcess","addEventListenerToDocument","let","event","document","addEventListener","eventListener","removeEventListenerToDocument","removeEventListener","getEventPath","e","parentElement","path","target","parent","length","pop","push","getCheckersWithPropsByEventPath","checkerKey","eventPath","isCapture","dom","vnode","checker","checkers","_vnode","props","prepChecker","prepProps","prepDom","getCheckers","eventType","eventPathReverse","key","indexOf","getEventPaths","composedPath","pathReverse","concat","reverse","p","pr","setEvent","responderKey","responder","plugin","getPlugin","prepView","prepEvent","prepResponder","prepType","type","initView","onResponderGrant","handleResponderTransferRequest","definition","getCurrentView","onResponderTerminationRequest","onResponderTerminate","onResponderReject","handleActiveTouches","touchHistory","numberActiveTouches","nativeEvent","touches","isStartish","start","isMoveish","move","isEndish","end","getCurrentEvent","view","getCurrentResponder","executeResponder","item","onResponderEnd","onResponderRelease","result","extractEvents","options","_root","node","apply","arguments","_commit","vnodes","child","_dom","_children","touchstart","mousedown","touchmove","mousemove","touchend","mouseup","injectedPlugins","Object","assign","nativeEventTarget","eventTypes","responderMove","dependencies"],"mappings":"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"}